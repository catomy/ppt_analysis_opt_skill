## 目标理解
- 你要我解释的是“整个 skill 的工作原理”，而不是仅测试文件。
- 新增/明确的规范：
  - 标题必须单行显示；如果会换行，需要生成更短的标题表达。
  - 标题字号控制在 24–30 之间，并且全稿标题字号/字体/颜色风格统一。
  - 全稿默认字体为微软雅黑。
  - LLM 的职责更偏向“修改建议文本（modification_suggestion）”，不希望为了样式规范在每条 suggestions 里逐条附带大量格式指令。

## 我将如何解释（你确认后我再按此结构输出最终说明文档/说明段落）
### 概要（先讲清楚系统分层）
- 抽取层：把 PPTX 解析成“可被 LLM 理解”的结构化 JSON。
- 分析层（Claude Prompt）：逐页逐段识别问题，并产出 suggestions（每条含位置与替换文本）。
- 转换层：把 suggestions 归并为 modify_ppt 能执行的 modifications（按页、按目标）。
- 应用层：按稳定定位（shape+段落）或兼容索引，把文本替换写回 PPTX。
- 校验层：最小化回归测试保证“能抽、能改、不会改错”。

### 细节（逐模块解释关键算法与边界）
- text_extraction：阅读顺序排序、标题识别、段落扁平化索引、shape 元数据（用于稳定定位）。
- SKILL.md Prompt：为什么是“逐页逐点分析 + 输出结构化 JSON”；哪些规则由 LLM 负责、哪些应交给代码做确定性处理。
- prompt_template：如何把 suggestions 转为 modifications；为什么优先用 stable locator。
- modify_ppt：如何定位段落、如何保留格式、如何做 old_text 校验与降级替换。
- 限制说明：python-pptx 没有排版渲染引擎，无法 100% 精确判断“视觉上是否换行”，需要用启发式 + LLM 约束（字数/断行符）双保险。

## 为满足“标题单行 + 统一字体样式”，需要新增的实现（你确认后我会改代码并跑测试）
### 1) 把“标题单行”变成可执行规则
- Prompt 侧：明确要求 title 的 `modification_suggestion` 不能包含换行符，并控制在一个可配置的最大字数（例如中文 18–24 字，默认 20 字）。
- 代码侧：增加启发式检测（仅作为提示/兜底）：若标题文本含 `\n` 或明显过长（按 textbox 宽度+字号估算），标记为需缩短；必要时触发“二次改写”模式（只改标题文本）。

### 2) 把“统一标题字号/字体/颜色 + 全稿微软雅黑”从 LLM 职责中剥离
- 新增一个确定性的样式归一化步骤（建议在 apply_modifications 后执行）：
  - 全文 runs 的 `font.name = 微软雅黑`
  - 标题 runs 的 `font.size` 统一到一个默认值（例如 28pt，且保证在 24–30 区间内）
  - 标题颜色：
    - 方案A（默认更安全）：保持主题自动颜色不强行覆盖，只统一字体与字号
    - 方案B（按你要求强一致）：从首页标题提取首个显式 RGB 作为 canonical，统一到所有标题
- 这样 LLM 仍然逐页逐点输出“内容替换建议”，样式一致性由代码一次性处理，不需要在每条 suggestions 里重复描述。

### 3) 输出/输入契约调整（符合“LLM 只改建议部分”）
- 提供两种模式（并保持向后兼容）：
  - Full 模式：LLM 输出完整 suggestions/report（现有）。
  - Refine 模式：给定“已生成的 suggestions JSON”，LLM 仅返回同结构但只改 `modification_suggestion`（其余字段保持原值）；转换器与修改器照常工作。

### 4) 增加回归测试覆盖样式与标题单行规则
- 新增测试：应用 style normalization 后，随机抽查多个 run 的字体为微软雅黑；标题字号落在 24–30。
- 新增测试：标题中出现换行/超长时，Refine 模式能产出更短标题（用 mock/固定输入验证）。

## 交付物
- 一份“skill 全流程工作原理说明”（概要+细节）。
- SKILL.md Prompt 更新（加入标题单行/标题字数上限/Refine 模式说明）。
- modify_ppt 支持样式归一化（不靠 LLM 逐条建议）。
- 对应测试用例补齐。

确认后我会按上述方案修改实现与文档，并保证本地测试通过。